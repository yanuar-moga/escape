<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aplikasi Sinkronisasi Nilai</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body { background: #f3f6fa; }
        .step-box { border-left: 5px solid #0d6efd; padding-left: 15px; }
    </style>
</head>
<body class="p-4">

<div class="container">
    <h2 class="mb-4 fw-bold">Aplikasi Sinkronisasi Nilai Siswa</h2>

    <!-- STEP 1: LOAD GOOGLE SHEET -->
    <div class="card shadow-sm mb-4">
        <div class="card-body step-box">
            <h5 class="card-title">1. Load Data dari Google Sheet</h5>
            <p>Data akan diambil dari sheet: <b>Form Responses 1!A1:E300</b></p>
            <button id="btnLoadSheet" class="btn btn-primary">Load Data</button>
            <div id="loadStatus" class="mt-3 text-secondary"></div>
        </div>
    </div>

    <!-- STEP 2: UPLOAD EXCEL -->
    <div class="card shadow-sm mb-4" id="uploadSection" style="display:none;">
        <div class="card-body step-box">
            <h5>2. Upload Data Siswa (Excel)</h5>
            <input type="file" id="excelInput" class="form-control" accept=".xlsx,.xls" />
            <div id="excelStatus" class="mt-3 text-secondary"></div>
        </div>
    </div>

    <!-- STEP 3: SYNC DATA -->
    <div class="card shadow-sm mb-4" id="syncSection" style="display:none;">
        <div class="card-body step-box">
            <h5>3. Sinkronisasi Nilai</h5>
            <button id="btnSync" class="btn btn-warning">Sync Nilai</button>
            <div id="syncStatus" class="mt-3 text-secondary"></div>
        </div>
    </div>

    <!-- STEP 4: OUTPUT TABLE -->
    <div class="card shadow-sm mb-4" id="resultSection" style="display:none;">
        <div class="card-body step-box">
            <h5>4. Hasil Sinkronisasi</h5>
            <table class="table table-bordered" id="resultTable"></table>
            <button id="btnDownload" class="btn btn-success mt-3">Download Excel</button>
        </div>
    </div>

</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyhIGJdsCj97KCosh64tDKXahyJU3Pxnj8xxhD2A9ColMYLAPKPuG0cMakodB8TQwsKOw/exec";

let sheetData = [];
let excelData = [];
let mergedData = [];

// ==================== STEP 1 - LOAD GOOGLE SHEET ====================
document.getElementById("btnLoadSheet").onclick = async () => {
    document.getElementById("loadStatus").innerHTML = "Mengambil data dari Google Sheet…";

    try {
        const res = await fetch(`${SCRIPT_URL}?sheet=Form Responses 1`);
        const json = await res.json();

        sheetData = json.data;

        // Sort by timestamp ASC
        sheetData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        document.getElementById("loadStatus").innerHTML = 
            `<span class='text-success'>Berhasil load ${sheetData.length} data!</span>`;

        document.getElementById("uploadSection").style.display = "block";

    } catch (err) {
        document.getElementById("loadStatus").innerHTML = 
            `<span class='text-danger'>Gagal load: ${err}</span>`;
    }
};

// ==================== STEP 2 - UPLOAD EXCEL ====================
document.getElementById("excelInput").addEventListener("change", function (e) {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = function (event) {
        const workbook = XLSX.read(event.target.result, { type: "binary" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        excelData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        document.getElementById("excelStatus").innerHTML = 
            `<span class='text-success'>Excel berhasil dibaca (${excelData.length} baris)</span>`;

        document.getElementById("syncSection").style.display = "block";
    };

    reader.readAsBinaryString(file);
});

// ==================== STEP 3 - SYNC ====================
document.getElementById("btnSync").onclick = () => {
    document.getElementById("syncStatus").innerHTML = "Proses sinkronisasi…";

    mergedData = [];
    const excelRows = excelData.slice(1);
    const sheetRows = sheetData;

    excelRows.forEach(row => {
        const namaExcel = row[1]?.toString().trim().toLowerCase();
        const kelasExcel = row[2];

        // Ambil semua nilai siswa dari sheet (semua timestamp)
        const attempts = sheetRows.filter(
            s => s.nama.toString().trim().toLowerCase() === namaExcel
        );

        // Ambil max 5 attempt
        const scores = attempts.map(a => Number(a.nilai)).slice(0, 5);

        while (scores.length < 5) scores.push(""); // jika kurang dari 5

        const scoreAkhir = Math.max(...scores.filter(n => n !== ""))

        mergedData.push({
            no: row[0],
            nama: row[1],
            kelas: kelasExcel,
            score1: scores[0] || "",
            score2: scores[1] || "",
            score3: scores[2] || "",
            score4: scores[3] || "",
            score5: scores[4] || "",
            scoreAkhir: isFinite(scoreAkhir) ? scoreAkhir : ""
        });
    });

    displayTable();
};

// ==================== DISPLAY TABLE ====================
function displayTable() {
    document.getElementById("resultSection").style.display = "block";

    let html = `
        <tr class='table-primary'>
            <th>No</th>
            <th>Nama</th>
            <th>Kelas</th>
            <th>Score 1</th>
            <th>Score 2</th>
            <th>Score 3</th>
            <th>Score 4</th>
            <th>Score 5</th>
            <th>Score Akhir</th>
        </tr>
    `;

    mergedData.forEach(r => {
        html += `
        <tr>
            <td>${r.no}</td>
            <td>${r.nama}</td>
            <td>${r.kelas}</td>
            <td>${r.score1}</td>
            <td>${r.score2}</td>
            <td>${r.score3}</td>
            <td>${r.score4}</td>
            <td>${r.score5}</td>
            <td class='fw-bold text-success'>${r.scoreAkhir}</td>
        </tr>`;
    });

    document.getElementById("resultTable").innerHTML = html;
    document.getElementById("syncStatus").innerHTML = "Sinkronisasi selesai!";
}

// ==================== DOWNLOAD EXCEL ====================
document.getElementById("btnDownload").onclick = () => {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(mergedData);
    XLSX.utils.book_append_sheet(wb, ws, "Hasil Sinkron");
    XLSX.writeFile(wb, "hasil_sinkron.xlsx");
};
</script>

</body>
</html>
