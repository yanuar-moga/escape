<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aplikasi Mapping Nilai Siswa</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background: #f3f6ff; }
.card { border-radius: 18px; }
</style>
</head>
<body class="p-4">
<div class="container">

<h2 class="text-center fw-bold text-primary mb-4">Aplikasi Mapping Nilai Siswa</h2>

<!-- STEP 1 LOAD SHEET -->
<div class="card shadow-sm p-4 mb-4" id="step1">
  <h4 class="fw-bold">1. Load Data Google Sheet</h4>
  <label class="form-label mt-2">Spreadsheet ID</label>
  <input id="sheetId" class="form-control" placeholder="Masukkan ID Spreadsheet">

  <label class="form-label mt-3">Nama Sheet</label>
  <input id="sheetName" class="form-control" value="Sheet1">

  <button class="btn btn-primary mt-3" onclick="loadSheet()">Load Data</button>

  <div id="loadStatus" class="mt-3 text-secondary"></div>
</div>

<!-- STEP 2 UPLOAD EXCEL -->
<div class="card shadow-sm p-4 mb-4 d-none" id="step2">
  <h4 class="fw-bold">2. Upload Excel Daftar Siswa</h4>
  <input type="file" id="excelInput" accept=".xlsx" class="form-control mt-2">
</div>

<!-- STEP 3 SYNC -->
<div class="card shadow-sm p-4 mb-4 d-none" id="step3">
  <h4 class="fw-bold">3. Sinkronisasi Nilai</h4>
  <button class="btn btn-success" onclick="syncData()">Synchronize</button>
</div>

<!-- STEP 4 DOWNLOAD -->
<div class="card shadow-sm p-4 mb-4 d-none" id="step4">
  <h4 class="fw-bold">4. Download Hasil</h4>
  <button class="btn btn-outline-primary" onclick="exportExcel()">Download Excel</button>
</div>

<!-- RESULT TABLE -->
<div class="card shadow-sm p-4 mb-4 d-none" id="resultCard">
  <h4 class="fw-bold">Hasil Mapping</h4>
  <div class="table-responsive mt-3">
    <table class="table table-bordered" id="resultTable">
      <thead class="table-primary">
        <tr>
          <th>Nama</th>
          <th>Kelas Excel</th>
          <th>Kelas Google</th>
          <th>Score</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

</div>

<script>
let rawNilai = [];
let excelData = [];
let mapped = [];

// NORMALIZE NAMA
function normalize(s){ return s.toLowerCase().replace(/\s+/g, "").trim(); }

// LOAD GOOGLE SHEET
async function loadSheet(){
  const id = document.getElementById("sheetId").value.trim();
  const name = document.getElementById("sheetName").value.trim();

  document.getElementById("loadStatus").innerHTML = "Memuat data...";

  const url = `https://script.google.com/macros/s/AKfycbwCJw9TUnX_YbNkWMqLZTsDwatTgUvM0mEGhBaQ09V8DPpoLtVPnovqFNT99lsjFqcu5w/exec?sheetId=${id}&sheetName=${name}`;

  try{
    const res = await fetch(url);
    const json = await res.json();

    if(json.status !== "success") throw "Gagal membaca sheet";

    rawNilai = json.data;
    document.getElementById("loadStatus").innerHTML = "✔ Data berhasil dimuat!";

    document.getElementById("step2").classList.remove("d-none");

  }catch(e){
    document.getElementById("loadStatus").innerHTML = "❌ Gagal load: " + e;
  }
}

// UPLOAD EXCEL
excelInput.addEventListener("change", function(){
  const reader = new FileReader();
  reader.onload = function(e){
    const wb = XLSX.read(e.target.result, {type:"binary"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    excelData = XLSX.utils.sheet_to_json(ws, {header:1});
    document.getElementById("step3").classList.remove("d-none");
  };
  reader.readAsBinaryString(this.files[0]);
});

// SYNC MAPPING
function syncData(){
  const out = [];

  const nilaiMap = new Map();
  for(let i=1;i<rawNilai.length;i++){
    const row = rawNilai[i];
    const nama = normalize(row[2]);
    nilaiMap.set(nama, {score: row[1], kelas: row[4]});
  }

  for(let j=1;j<excelData.length;j++){
    const r = excelData[j];
    const nama = r[1];
    const kelasExcel = r[2];
    const key = normalize(nama);
    let status = "Match";

    if(nilaiMap.has(key)){
      const obj = nilaiMap.get(key);
      out.push([nama, kelasExcel, obj.kelas, obj.score, "✔ Cocok"]);
    }else{
      out.push([nama, kelasExcel, "-", "-", "❌ Tidak ditemukan"]);
    }
  }

  mapped = out;
  renderTable();
  document.getElementById("step4").classList.remove("d-none");
  document.getElementById("resultCard").classList.remove("d-none");
}

// RENDER TABEL
function renderTable(){
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";

  mapped.forEach(r=>{
    const tr = document.createElement("tr");
    if(r[4].includes("❌")) tr.classList.add("table-danger");
    tr.innerHTML = `<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td>`;
    tbody.appendChild(tr);
  });
}

// DOWNLOAD EXCEL
function exportExcel(){
  const ws = XLSX.utils.aoa_to_sheet([["Nama","Kelas Excel","Kelas Google","Score","Status"], ...mapped]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Hasil");
  XLSX.writeFile(wb, "mapping_nilai.xlsx");
}

</script>

</body>
</html>

