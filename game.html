<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Escape Room Informatika</title>

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(120deg,#4da3ff,#007bff);
    color:#fff;
    margin:0;
    padding:0;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    overflow:hidden;
  }

  #game-box {
    width:90%;
    max-width:850px;
    background:#ffffff20;
    padding:20px;
    border-radius:14px;
    text-align:center;
    box-shadow:0 0 15px rgba(0,0,0,.25);
    animation: fadeIn .8s ease;
    backdrop-filter: blur(3px);
  }

  @keyframes fadeIn { from{opacity:0;transform:scale(.8)} to{opacity:1;transform:scale(1)} }

  .avatar {
    position:absolute;
    top:14px; left:14px;
    width:60px; height:60px;
    border-radius:50%;
    border:2px solid #fff;
  }

  #timer {
    font-size:23px;
    font-weight:600;
    margin:10px;
    color:#ffd84c;
  }

  .question-box {
    font-size:20px;
    margin-top:10px;
    margin-bottom:20px;
    color:#fff;
  }

  .answers button {
    width:80%;
    max-width:500px;
    margin:8px auto;
    padding:10px;
    font-size:15px;
    border:none;
    border-radius:8px;
    background:#ffd84c;
    color:#000;
    cursor:pointer;
    transition:.25s;
  }

  .answers button:hover { transform:scale(1.05) }

  .popup {
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%, -50%);
    background:#fff;
    padding:18px 22px;
    border-radius:10px;
    color:#333;
    font-size:20px;
    display:none;
    box-shadow:0 0 12px rgba(0,0,0,.3);
  }

  .popup.show { display:block }

  #win-screen {
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,.8);
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    color:#fff;
    font-size:30px;
    display:none;
  }

  #win-screen img {
    width:180px;
    margin-bottom:10px;
    animation:bounce 1s infinite;
  }

  @keyframes bounce {
    0% { transform:translateY(0) }
    50% { transform:translateY(-10px) }
    100% { transform:translateY(0) }
  }
</style>
</head>
<body>

<img class="avatar" id="avatar">
<div id="game-box">
  <div id="timer">00:30</div>
  <div class="question-box" id="question-text">Memuat soal...</div>
  <div class="answers" id="answer-buttons"></div>
</div>

<div class="popup" id="popupInfo">Huruf Misteri: A</div>

<div id="win-screen">
  <img src="assets/img/flag.png">
  <div>Selamat, kamu menemukan kata rahasia!</div>
</div>

<!-- AUDIO -->
<audio id="audioCorrect" src="assets/sound/cling.mp3"></audio>
<audio id="audioWrong" src="assets/sound/buzz.mp3"></audio>
<audio id="audioWin" src="assets/sound/win.mp3"></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBr-nd0dxZl5q6DLPxMKLybJ7MyBc9kaBc",
    authDomain: "realtime-database-f59b8.firebaseapp.com",
    databaseURL: "https://realtime-database-f59b8-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "realtime-database-f59b8",
    storageBucket: "realtime-database-f59b8.firebasestorage.app",
    messagingSenderId: "320982155387",
    appId: "1:320982155387:web:df67817761e282dee4a2de"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Ambil data login
  const urlParams = new URLSearchParams(window.location.search);
  const kelompok = urlParams.get("kelompok");
  const avatarPic = urlParams.get("avatar");

  document.getElementById("avatar").src = avatarPic;

  let questions = [];
  let currentIndex = 0;
  let timerInterval;

  // Ambil soal dan kata misteri dari Firebase
  async function loadQuestions(){
    const snap = await get(ref(db, "soal"));
    if(!snap.exists()) {
      document.getElementById("question-text").innerText = "Belum ada soal di database.";
      return;
    }

    questions = Object.values(snap.val());
    showQuestion();
  }

  function startTimer(){
    let time = 30;
    document.getElementById("timer").innerText = "00:30";

    timerInterval = setInterval(()=>{
      time--;
      document.getElementById("timer").innerText = "00:" + (time<10?"0"+time:time);

      if(time <= 0){
        clearInterval(timerInterval);
        wrongAnswer(); // waktu habis = salah
      }
    },1000);
  }

  function showQuestion(){
    if(currentIndex >= questions.length){
      win();
      return;
    }

    const q = questions[currentIndex];
    document.getElementById("question-text").innerText = q.question;
    document.getElementById("answer-buttons").innerHTML = "";

    let opts = [q.a, q.b, q.c, q.d].sort(()=>Math.random()-0.5);

    opts.forEach(txt=>{
      const btn = document.createElement("button");
      btn.innerText = txt;
      btn.onclick = ()=> checkAnswer(txt === q.correct, q.mysteryLetter);
      document.getElementById("answer-buttons").appendChild(btn);
    });

    startTimer();
  }

  function checkAnswer(isCorrect, letter){
    clearInterval(timerInterval);

    if(isCorrect){
      document.getElementById("audioCorrect").play();
      showPopup(letter);
      saveProgress(currentIndex+1);
      currentIndex++;
      setTimeout(showQuestion,1200);
    }else{
      wrongAnswer();
    }
  }

  function wrongAnswer(){
    document.getElementById("audioWrong").play();
    if(currentIndex > 0) currentIndex--;
    setTimeout(showQuestion,800);
  }

  function showPopup(letter){
    const pop = document.getElementById("popupInfo");
    pop.innerText = "Huruf Misteri: " + letter;
    pop.classList.add("show");
    setTimeout(()=> pop.classList.remove("show"), 1000);
  }

  function saveProgress(progress){
    update(ref(db, "progress/"+kelompok), {
      current: progress,
      lastUpdate: Date.now()
    });
  }

  function win(){
    document.getElementById("audioWin").play();
    document.getElementById("win-screen").style.display = "flex";
  }

  loadQuestions();
</script>

</body>
</html>
