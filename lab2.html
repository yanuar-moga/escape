<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Inventaris Lab 2</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .map-cell {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ddd;
        margin: 2px;
        border-radius: 6px;
        font-weight: bold;
        font-size: 18px;
        color: #000;
    }
    .normal { background-color: #81ff81; }
    .ringan { background-color: #ffc266; }
    .berat  { background-color: #ff7474; }
    .empty  { background-color: #e5e5e5; }
</style>

</head>
<body class="bg-gray-100 p-6">

<h1 class="text-3xl font-bold mb-6">Dashboard Inventaris Laptop Lab 2</h1>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="statsCards"></div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
    <div class="bg-white p-4 rounded-xl shadow">
        <canvas id="chartKondisi"></canvas>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
        <canvas id="chartAksesoris"></canvas>
    </div>
</div>

<h2 class="text-3xl font-bold mt-10 mb-4">Data Inventaris (Sheet INV)</h2>
<div class="bg-white p-4 rounded-xl shadow overflow-auto" id="invTable"></div>

<h2 class="text-3xl font-bold mt-10 mb-4">Pemetaan Laptop (Sheet MAP)</h2>
<div class="bg-white p-4 rounded-xl shadow p-4 overflow-auto" id="mapContainer"></div>

<script>
let INV = [];

async function loadExcel() {
    const file = "https://raw.githubusercontent.com/yanuar-moga/escape/main/assets/inventarislab2.xlsx";

    const data = await fetch(file).then(res => res.arrayBuffer());
    const wb = XLSX.read(data, { type: "array" });

    INV = XLSX.utils.sheet_to_json(wb.Sheets["INV"]);
    const MAP_RAW = XLSX.utils.sheet_to_json(wb.Sheets["MAP"], { header: 1 });

    const MAP = cleanMap(MAP_RAW);

    renderInvTable(INV);
    renderStats(INV);
    renderCharts(INV);
    renderMap(MAP, INV);
}

function cleanMap(mapRaw) {
    return mapRaw.filter(row => row.some(cell => cell !== null && cell !== ""));
}

function renderInvTable(data) {
    const sheet = XLSX.utils.json_to_sheet(data);
    const html = XLSX.utils.sheet_to_html(sheet);
    document.getElementById("invTable").innerHTML = html;
}

function renderStats(inv) {
    const normal = inv.filter(x => (x.Kondisi || "").toLowerCase() === "normal").length;
    const ringan = inv.filter(x => (x.Kondisi || "").toLowerCase().includes("ringan")).length;
    const berat = inv.filter(x => (x.Kondisi || "").toLowerCase().includes("berat")).length;

    const mouseAda = inv.filter(x => (x.Mouse || "").toUpperCase() === "ADA").length;
    const kbAda = inv.filter(x => (x.Keyboard || "").toUpperCase() === "ADA").length;

    const stats = [
        { title: "Total Laptop", value: inv.length },
        { title: "Normal", value: normal },
        { title: "Rusak Ringan", value: ringan },
        { title: "Rusak Berat", value: berat },
        { title: "Mouse Ada", value: mouseAda },
        { title: "Keyboard Ada", value: kbAda },
    ];

    let html = "";
    stats.forEach(s => {
        html += `
        <div class="bg-white p-6 rounded-xl shadow text-center">
            <div class="text-4xl font-bold">${s.value}</div>
            <div class="text-gray-600">${s.title}</div>
        </div>`;
    });

    document.getElementById("statsCards").innerHTML = html;
}

function renderCharts(inv) {
    const normal = inv.filter(x => (x.Kondisi || "").toLowerCase() === "normal").length;
    const ringan = inv.filter(x => (x.Kondisi || "").toLowerCase().includes("ringan")).length;
    const berat = inv.filter(x => (x.Kondisi || "").toLowerCase().includes("berat")).length;

    new Chart(document.getElementById("chartKondisi"), {
        type: "pie",
        data: {
            labels: ["Normal", "Rusak Ringan", "Rusak Berat"],
            datasets: [{ data: [normal, ringan, berat] }]
        }
    });

    const mouseAda = inv.filter(x => (x.Mouse || "").toUpperCase() === "ADA").length;
    const mouseTidak = inv.length - mouseAda;

    const kbAda = inv.filter(x => (x.Keyboard || "").toUpperCase() === "ADA").length;
    const kbTidak = inv.length - kbAda;

    new Chart(document.getElementById("chartAksesoris"), {
        type: "bar",
        data: {
            labels: ["Mouse Ada", "Mouse Tidak", "Keyboard Ada", "Keyboard Tidak"],
            datasets: [{ data: [mouseAda, mouseTidak, kbAda, kbTidak] }]
        }
    });
}

function renderMap(map, inv) {
    const mid = Math.floor(map[0].length / 2); 

    let left = [];
    let right = [];

    map.forEach(row => {
        left.push(row.slice(0, mid));
        right.push(row.slice(mid));
    });

    let html = `
    <div class="flex gap-10">
        <div>${makeGrid(left, inv)}</div>
        <div>${makeGrid(right, inv)}</div>
    </div>`;

    document.getElementById("mapContainer").innerHTML = html;
}

function makeGrid(block, inv) {
    let cols = block[0].length;
    let html = `<div class="grid grid-cols-${cols}">`;

    block.forEach(row => {
        row.forEach(cell => {
            if (cell === "" || cell == null) {
                html += `<div class="map-cell empty"></div>`;
                return;
            }

            const item = inv.find(x => Number(x["NO MEJA"]) === Number(cell));
            let kelas = "empty";

            if (item) {
                let k = (item.Kondisi || "").toLowerCase();
                if (k === "normal") kelas = "normal";
                else if (k.includes("ringan")) kelas = "ringan";
                else if (k.includes("berat")) kelas = "berat";
            }

            html += `<div class="map-cell ${kelas}">${cell}</div>`;
        });
    });

    html += `</div>`;
    return html;
}

loadExcel();
</script>

</body>
</html>
