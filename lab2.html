<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Inventaris Lab 2</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- html2canvas & jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    .map-cell {
        width: 60px;
        height: 60px;
        display:flex;
        align-items:center;
        justify-content:center;
        border:1px solid #ddd;
        margin:2px;
        border-radius:8px;
        font-weight:bold;
        font-size:18px;
        cursor:pointer;
    }
    .normal { background:#7CFF7C; }
    .ringan { background:#FFD27F; }
    .berat { background:#FF7C7C; }
    .empty { background:#dcdcdc; }

    .modal {
        position: fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:rgba(0,0,0,0.5);
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:50;
    }
</style>

</head>
<body class="bg-gray-100 p-6">

<h1 class="text-3xl font-bold mb-6">Dashboard Inventaris Laptop Lab 2</h1>

<button onclick="exportPDF()" class="px-4 py-2 bg-blue-600 text-white rounded shadow">
    Export PDF (Dashboard)
</button>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6" id="statsCards"></div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
    <div class="bg-white p-4 rounded-xl shadow">
        <canvas id="chartKondisi"></canvas>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
        <canvas id="chartAksesoris"></canvas>
    </div>
</div>

<h2 class="text-3xl font-bold mt-10 mb-4 text-center">Pemetaan Laptop</h2>
<div class="text-center font-bold mb-4 text-lg">MEJA GURU</div>

<div class="bg-white p-4 rounded-xl shadow overflow-auto" id="mapContainer"></div>

<div id="modal" class="hidden"></div>

<script>
let INV = [];

async function loadExcel() {
    const file = "https://raw.githubusercontent.com/yanuar-moga/escape/main/assets/inventarislab2.xlsx";

    const data = await fetch(file).then(res => res.arrayBuffer());
    const wb = XLSX.read(data, { type:"array" });

    INV = XLSX.utils.sheet_to_json(wb.Sheets["INV"]);
    const MAP_RAW = XLSX.utils.sheet_to_json(wb.Sheets["MAP"], { header:1 });

    const MAP = MAP_RAW.filter(r => r.some(c => c !== null && c !== ""));

    renderStats(INV);
    renderCharts(INV);
    renderMap(MAP, INV);
}

function renderStats(inv) {
    const normal = inv.filter(x => x.Kondisi?.toLowerCase() === "normal").length;
    const ringan = inv.filter(x => x.Kondisi?.toLowerCase().includes("ringan")).length;
    const berat = inv.filter(x => x.Kondisi?.toLowerCase().includes("berat")).length;

    const chromebook = inv.filter(x => (x.OS || "").toLowerCase().includes("chrome")).length;

    const laptopCount = inv.length - chromebook;

    const mouseNeed = inv.filter(x => (x.Mouse || "").toLowerCase() !== "ada").length;
    const kbNeed = inv.filter(x => (x.Keyboard || "").toLowerCase() !== "ada").length;

    const stats = [
        { title:"Total Laptop", value:laptopCount },
        { title:"Total Chromebook", value:chromebook },
        { title:"Laptop Normal", value:normal },
        { title:"Rusak Ringan", value:ringan },
        { title:"Rusak Berat", value:berat },
        { title:"Kebutuhan Mouse", value:mouseNeed },
        { title:"Kebutuhan Keyboard", value:kbNeed },
    ];

    let html = "";
    stats.forEach(s => {
        html += `
        <div class="bg-white p-6 rounded-xl shadow text-center">
            <div class="text-4xl font-bold">${s.value}</div>
            <div class="text-gray-600">${s.title}</div>
        </div>`;
    });

    document.getElementById("statsCards").innerHTML = html;
}

function renderCharts(inv) {
    const normal = inv.filter(x => x.Kondisi?.toLowerCase() === "normal").length;
    const ringan = inv.filter(x => x.Kondisi?.toLowerCase().includes("ringan")).length;
    const berat = inv.filter(x => x.Kondisi?.toLowerCase().includes("berat")).length;

    new Chart(chartKondisi, {
        type:"pie",
        data:{
            labels:["Normal","Ringan","Berat"],
            datasets:[{ data:[normal, ringan, berat] }]
        }
    });

    const mouseNeed = inv.filter(x => (x.Mouse || "").toLowerCase() !== "ada").length;
    const kbNeed = inv.filter(x => (x.Keyboard || "").toLowerCase() !== "ada").length;

    new Chart(chartAksesoris, {
        type:"bar",
        data:{
            labels:["Kebutuhan Mouse","Kebutuhan Keyboard"],
            datasets:[{ data:[mouseNeed, kbNeed] }]
        }
    });
}

function renderMap(MAP, INV) {
    let html = '<div class="flex justify-center gap-16">';

    MAP.forEach(row => {
        let left = row.slice(0,6);
        let right = row.slice(7);

        html += `
        <div class="grid grid-cols-6">${makeCells(left, INV)}</div>
        <div class="grid grid-cols-4">${makeCells(right, INV)}</div>
        `;
    });

    html += "</div>";
    document.getElementById("mapContainer").innerHTML = html;
}

function makeCells(row, INV) {
    let html = "";
    row.forEach(num => {
        if (!num) {
            html += `<div class="map-cell empty"></div>`;
            return;
        }

        const item = INV.find(x => Number(x["NO MEJA"]) === Number(num));
        let cls = "empty";

        if (item) {
            const k = item.Kondisi.toLowerCase();
            if (k === "normal") cls = "normal";
            else if (k.includes("ringan")) cls = "ringan";
            else if (k.includes("berat")) cls = "berat";
        }

        html += `<div class="map-cell ${cls}" onclick="showDetail(${num})">${num}</div>`;
    });

    return html;
}

function showDetail(noMeja) {
    const item = INV.find(x => Number(x["NO MEJA"]) === Number(noMeja));

    let modalHTML = `
    <div class="modal" onclick="closeModal()">
        <div class="bg-white p-6 rounded-xl shadow max-w-lg w-full" onclick="event.stopPropagation()">

            <h2 class="text-2xl font-bold mb-4">Detail Meja ${noMeja}</h2>

            ${item ? `
                <p><b>No Inventaris:</b> ${item["NO INVENTARIS"] || "-"}</p>
                <p><b>Nama Barang:</b> ${item["NAMA BARANG"] || "-"}</p>
                <p><b>Merek / Tipe:</b> ${item["Merek / Tipe"] || "-"}</p>
                <p><b>OS:</b> ${item["OS"] || "-"}</p>
                <p><b>Kondisi:</b> ${item["Kondisi"]}</p>
                <p><b>Mouse:</b> ${item.Mouse}</p>
                <p><b>Keyboard:</b> ${item.Keyboard}</p>
                <p><b>Keterangan:</b> ${item.Keterangan || "-"}</p>
            ` : `<p class='text-red-600 font-bold'>Tidak ada laptop di meja ini.</p>`}

        </div>
    </div>`;

    document.getElementById("modal").innerHTML = modalHTML;
    document.getElementById("modal").classList.remove("hidden");
}

function closeModal() {
    document.getElementById("modal").classList.add("hidden");
}

async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");

    const element = document.body;
    const canvas = await html2canvas(element, { scale:2 });
    const img = canvas.toDataURL("image/png");

    const pageWidth = pdf.internal.pageSize.getWidth();
    const imgProps = pdf.getImageProperties(img);
    const imgHeight = imgProps.height * pageWidth / imgProps.width;

    pdf.addImage(img, "PNG", 0, 0, pageWidth, imgHeight);
    pdf.save("Dashboard-Inventaris-Lab2.pdf");
}

loadExcel();
</script>

</body>
</html>
